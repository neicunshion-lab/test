import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, query, onSnapshot, orderBy, serverTimestamp } from 'firebase/firestore';
import { Clock, MessageSquare, List, Home, Users, Camera, XCircle, CheckCircle } from 'lucide-react';

// --- Firebase Global Variables (Mandatory) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'senior-support-app';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
// ä¿®æ­£: __initialAuthToken ã§ã¯ãªã __initial_auth_token ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
// ---------------------------------------------

// --- UI Constants for Senior View (Pop Design Update) ---
const LARGE_TEXT = 'text-2xl sm:text-3xl font-black'; // ãƒ•ã‚©ãƒ³ãƒˆã‚’å¤ªã
const BUTTON_PRIMARY = 'bg-pink-500 text-white rounded-2xl shadow-xl hover:bg-pink-600 transition duration-150 transform hover:scale-[1.02] active:bg-pink-700';
const BUTTON_SECONDARY = 'bg-emerald-400 text-white rounded-2xl shadow-xl hover:bg-emerald-500 transition duration-150 transform hover:scale-[1.02] active:bg-emerald-600';
const CARD_CLASSES = 'bg-white p-5 rounded-3xl shadow-lg border-t-4 border-pink-300'; // ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒãƒƒãƒ—åŒ–
const INPUT_CLASSES = 'w-full p-3 border border-gray-300 rounded-xl text-lg focus:ring-pink-400 focus:border-pink-400';

// --- Utility Functions ---
const timeAgo = (timestamp) => {
    if (!timestamp || !timestamp.seconds) return '---';
    const seconds = timestamp.seconds;
    const now = Date.now() / 1000;
    const diff = now - seconds;

    if (diff < 60) return `${Math.floor(diff)}ç§’å‰`;
    if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†å‰`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}æ™‚é–“å‰`;
    return `${Math.floor(diff / 86400)}æ—¥å‰`;
};

// ----------------------------------------------------------------------
// --- Main Application Component ---
// ----------------------------------------------------------------------

// Firestoreã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
const getBasePath = (appId, userId) => ['artifacts', appId, 'users', userId];
const getProfileRef = (db, appId, userId) => doc(db, ...getBasePath(appId, userId), 'profile', 'data');
const getInventoryCollection = (db, appId, userId) => collection(db, ...getBasePath(appId, userId), 'inventory');
const getActivityLogCollection = (db, appId, userId) => collection(db, ...getBasePath(appId, userId), 'activityLog');


const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [seniorId, setSeniorId] = useState(null);
    const [authReady, setAuthReady] = useState(false);
    const [mode, setMode] = useState('SETUP'); // 'SETUP', 'USER', 'FAMILY'
    const [loading, setLoading] = useState(true);

    const [inventory, setInventory] = useState([]);
    const [activityLog, setActivityLog] = useState([]);
    const [familyViewId, setFamilyViewId] = useState(''); // å®¶æ—ãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ID
    const [familyName, setFamilyName] = useState('å±±ç”° å¤ªéƒ'); // é«˜é½¢è€…ã®åå‰ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰

    // --- 6. å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£: å‚ç…§ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€æ—©æœŸã«å®šç¾©) ---

    const LoadingScreen = ({ message, isError = false }) => (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-6">
            <div className={`text-center p-8 rounded-xl shadow-2xl ${isError ? 'bg-red-100' : 'bg-white'}`}>
                {isError ? <XCircle size={48} className="text-red-500 mx-auto mb-4" /> : <Clock size={48} className="text-pink-500 mx-auto mb-4 animate-spin" />}
                <p className="text-xl font-medium text-gray-700">{message}</p>
                {isError && <p className="mt-2 text-red-600 font-semibold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>}
            </div>
        </div>
    );

    const InputGroup = ({ label, value, onChange, type = 'text', placeholder = '' }) => (
        <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
            <input
                type={type}
                value={value}
                onChange={(e) => onChange(e.target.value)}
                placeholder={placeholder}
                className={INPUT_CLASSES}
            />
        </div>
    );

    const LogEntry = ({ log, isSenior }) => {
        let bgColor = 'bg-gray-100';
        let icon = <Clock size={16} className="text-gray-500 mr-2" />;
        let textColor = 'text-gray-800';
        let alignment = 'justify-start';

        if (log.type === 'chat') {
            bgColor = 'bg-pink-100 border border-pink-300'; // ãƒãƒƒãƒ—ã‚«ãƒ©ãƒ¼ã«å¤‰æ›´
            icon = <MessageSquare size={16} className="text-pink-600 mr-2" />;
            alignment = 'justify-start';
        } else if (log.type === 'user_chat') {
            bgColor = 'bg-emerald-100 border border-emerald-300'; // ãƒãƒƒãƒ—ã‚«ãƒ©ãƒ¼ã«å¤‰æ›´
            icon = <MessageSquare size={16} className="text-emerald-600 mr-2" />;
            alignment = 'justify-end';
        } else if (log.type === 'photo') {
            bgColor = 'bg-yellow-100 border border-yellow-300';
            icon = <Camera size={16} className="text-yellow-600 mr-2" />;
            alignment = 'justify-start';
        } else if (log.type === 'family_order') {
            bgColor = 'bg-blue-100 border border-blue-300';
            icon = <Users size={16} className="text-blue-600 mr-2" />;
            alignment = 'justify-start';
        }
        
        return (
            <div className={`flex ${alignment}`}>
                <div className={`max-w-[80%] p-3 rounded-2xl ${bgColor} shadow-sm`}>
                    <p className={`text-sm text-gray-500 mb-1 flex items-center ${isSenior ? 'justify-end' : 'justify-start'}`}>
                        {icon}
                        {log.timestamp ? timeAgo(log.timestamp) : 'ä»Š'}
                    </p>
                    <p className={`text-base font-medium ${textColor}`}>{log.message}</p>
                </div>
            </div>
        );
    };

    const InventoryTable = ({ data, isFamily = false, seniorId, db, appId }) => {
        const deleteItem = async (itemId) => {
            if (!seniorId || !db) return;
            const inventoryRef = getInventoryCollection(db, appId, seniorId);
            await setDoc(doc(inventoryRef, itemId), { isDeleted: true }, { merge: true });
            alert('å•†å“ã‚’å‰Šé™¤ï¼ˆãƒãƒ¼ã‚¯ï¼‰ã—ã¾ã—ãŸã€‚');
        };

        const filteredData = data.filter(item => !item.isDeleted);

        if (filteredData.length === 0) {
            return <div className="p-6 bg-white rounded-3xl text-gray-500 text-center text-lg shadow-inner">ç™»éŒ²ã•ã‚ŒãŸåœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>;
        }

        return (
            <div className="overflow-x-auto bg-white rounded-3xl shadow-xl">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-pink-100">
                        <tr>
                            <th className="px-4 py-3 text-left text-sm font-bold text-pink-700 uppercase tracking-wider">å•†å“</th>
                            <th className="px-4 py-3 text-left text-sm font-bold text-pink-700 uppercase tracking-wider">åœ¨åº«æ•°</th>
                            <th className="px-4 py-3 text-left text-sm font-bold text-pink-700 uppercase tracking-wider">æ¬¡ã®ææ¡ˆã¾ã§</th>
                            <th className="px-4 py-3 text-left text-sm font-bold text-pink-700 uppercase tracking-wider">æœ€çµ‚æ›´æ–°</th>
                            {!isFamily && <th className="px-4 py-3 text-left text-sm font-bold text-pink-700 uppercase tracking-wider">æ“ä½œ</th>}
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-100">
                        {filteredData.map(item => (
                            <tr key={item.id} className={item.estimatedDaysLeft < 10 ? 'bg-red-50/70' : ''}>
                                <td className="px-4 py-4 whitespace-nowrap text-lg font-medium text-gray-900 flex items-center">
                                    <div className="h-10 w-10 bg-emerald-200 rounded-lg mr-3 flex items-center justify-center text-sm font-black text-emerald-800 shadow-inner">
                                        P
                                    </div>
                                    {item.name}
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap">
                                    <span className="text-xl font-extrabold text-pink-600">{item.currentStock}</span> å€‹
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap">
                                    <span className={`text-xl font-extrabold ${item.estimatedDaysLeft < 10 ? 'text-red-500' : 'text-emerald-600'}`}>
                                        {item.estimatedDaysLeft}
                                    </span> æ—¥
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {timeAgo(item.lastUpdated)}
                                </td>
                                {!isFamily && (
                                    <td className="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                        <button
                                            onClick={() => deleteItem(item.id)}
                                            className="text-red-500 hover:text-red-700 transition font-bold"
                                        >
                                            <XCircle size={20} className="inline mr-1" />å‰Šé™¤
                                        </button>
                                    </td>
                                )}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );
    };


    // 1. FirebaseåˆæœŸåŒ–ã¨èªè¨¼
    useEffect(() => {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            setLoading(false);
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);
            setDb(firestore);
            setAuth(authInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    const currentSeniorId = user.uid;
                    setSeniorId(currentSeniorId);
                    setMode('USER'); // èªè¨¼ãŒå®Œäº†ã—ãŸã‚‰é«˜é½¢è€…ãƒ¢ãƒ¼ãƒ‰ã¸
                    // ãƒ‡ãƒ¢ç”¨ã®é«˜é½¢è€…IDã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                    console.log(`ç¾åœ¨ã®é«˜é½¢è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (Familyã‚¢ã‚¯ã‚»ã‚¹ç”¨): ${currentSeniorId}`);
                    setAuthReady(true);

                    // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (åˆå›ã®ã¿)
                    const profileRef = getProfileRef(firestore, appId, currentSeniorId);
                    await setDoc(profileRef, {
                        name: familyName,
                        joinDate: serverTimestamp(),
                        sharedWith: []
                    }, { merge: true });

                } else {
                    // åŒ¿åèªè¨¼ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã‚’å®Ÿè¡Œ
                    if (initialAuthToken) {
                        await signInWithCustomToken(authInstance, initialAuthToken);
                    } else {
                        await signInAnonymously(authInstance);
                    }
                }
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase Initialization or Auth Error:", error);
            setLoading(false);
        }
    }, [firebaseConfig, initialAuthToken, familyName]);

    // 2. ãƒ‡ãƒ¼ã‚¿ç›£è¦– (onSnapshot)
    useEffect(() => {
        if (!db || !authReady || !seniorId) return;

        // å®¶æ—ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯familyViewIdã€ãã†ã§ãªã‘ã‚Œã°seniorIdã‚’ä½¿ç”¨
        const seniorDataId = mode === 'FAMILY_VIEW' ? familyViewId : seniorId; 
        if (!seniorDataId) return;

        setLoading(true);

        const inventoryRef = getInventoryCollection(db, appId, seniorDataId);
        const activityRef = getActivityLogCollection(db, appId, seniorDataId);

        // åœ¨åº«ãƒªã‚¹ãƒˆã®ç›£è¦–
        const unsubscribeInv = onSnapshot(inventoryRef, (snapshot) => {
            const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            setInventory(items);
            setLoading(false);
        }, (error) => {
            console.error("Inventory Snapshot Error:", error);
            setLoading(false);
        });

        // æ´»å‹•ãƒ­ã‚°ã®ç›£è¦–
        const unsubscribeLog = onSnapshot(query(activityRef, orderBy('timestamp', 'desc')), (snapshot) => {
            const logs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            setActivityLog(logs);
        }, (error) => {
            console.error("ActivityLog Snapshot Error:", error);
        });

        return () => {
            unsubscribeInv();
            unsubscribeLog();
        };
    }, [db, authReady, seniorId, mode, familyViewId]);

    // 3. AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ (å…±åŒä½œæ¥­å½¢å¼ã«å¤‰æ›´)
    const handleChatAction = useCallback(async (actionType, data = {}) => {
        if (!db || !seniorId) return;

        const currentSeniorId = mode === 'FAMILY_VIEW' ? familyViewId : seniorId;

        const activityRef = getActivityLogCollection(db, appId, currentSeniorId);

        const logAction = async (msg, type = 'chat') => {
            await setDoc(doc(activityRef), {
                type: type,
                message: msg,
                timestamp: serverTimestamp(),
                seniorId: currentSeniorId,
            });
        };

        if (actionType === 'CHECK_INVENTORY') {
            const needsAttention = inventory.filter(item => item.estimatedDaysLeft < 10 && item.currentStock > 0);
            
            let chatMessage = '';
            let followUpMessage = '';

            if (needsAttention.length > 0) {
                // å…±åŒä½œæ¥­ (1): è¦æ³¨æ„å•†å“ã‚’æ˜ç¢ºã«ä¼ãˆã¦ç¢ºèªã‚’ä¿ƒã™
                const firstItem = needsAttention[0].name;
                chatMessage = `AIï¼ˆã­ã“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ï¼‰: ã“ã‚“ã«ã‚ƒã¡ã¯ã€**${familyName}æ§˜**ï¼åœ¨åº«ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã«ã‚ƒã‚“ã€‚**${firstItem}**ãªã©${needsAttention.length}ç‚¹ã®å•†å“ãŒã€ã‚‚ã†ã™ããªããªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã«ã‚ƒï¼`;
                
                // å…±åŒä½œæ¥­ (2): æ¬¡ã®è¡Œå‹•ã‚’ä¿ƒã™
                followUpMessage = `AIï¼ˆã­ã“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ï¼‰: ç‰¹ã«**${firstItem}**ã¯ã€ä»Šã®ã†ã¡ã«ã€Œå†™çœŸã§åœ¨åº«ã‚’è¨˜éŒ²ã€ã—ã¦ã€æœ¬å½“ã«æ®‹ã‚ŠãŒå°‘ãªã„ã‹ç¢ºèªã—ã¦ã¿ã‚‹ã«ã‚ƒã‚“ï¼Ÿ`;

            } else {
                chatMessage = `AIï¼ˆã­ã“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ï¼‰: ã“ã‚“ã«ã‚ƒã¡ã¯ã€**${familyName}æ§˜**ï¼ã–ã£ã¨ãƒã‚§ãƒƒã‚¯ã—ãŸã‘ã©ã€æ€¥ã„ã§è²·ã†ã‚‚ã®ã¯ãªã•ãã†ã«ã‚ƒã‚“ã€‚ã”å®‰å¿ƒãã ã•ãƒ¼ã„ã€‚`;
                followUpMessage = `AIï¼ˆã­ã“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ï¼‰: ä»–ã«å¿ƒé…ãªã‚‚ã®ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚ã€Œå†™çœŸã§åœ¨åº«ã‚’è¨˜éŒ²ã€ã™ã‚‹ã«ã‚ƒã‚“ã‚ˆã€‚ä¸€ç·’ã«ç®¡ç†ã™ã‚‹ã«ã‚ƒï¼`;
            }
            
            logAction(chatMessage, 'chat');
            logAction(`ãƒ¦ãƒ¼ã‚¶ãƒ¼: åœ¨åº«ç¢ºèªã‚’é–‹å§‹`, 'user_chat');
            // æ™‚é–“å·®ã§æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå…±åŒä½œæ¥­ã®ææ¡ˆï¼‰ã‚’ãƒ­ã‚°ã«è¿½åŠ ï¼ˆUXä¸Šã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            setTimeout(() => { logAction(followUpMessage, 'chat'); }, 1000);

        } else if (actionType === 'ADD_ITEM') {
            const newItemId = new Date().getTime().toString();
            const { name, stock, days } = data;

            const inventoryUpdate = {
                name: name,
                currentStock: parseInt(stock, 10),
                lastUpdated: serverTimestamp(),
                estimatedDaysLeft: parseInt(days, 10),
                lastPurchaseDate: serverTimestamp(),
                photoUrl: "https://placehold.co/100x100/A0B9E2/000000?text=å†™çœŸ",
            };
            
            const inventoryCollection = getInventoryCollection(db, appId, currentSeniorId);
            await setDoc(doc(inventoryCollection, newItemId), inventoryUpdate);
            
            // å…±åŒä½œæ¥­ (1): ç™»éŒ²å®Œäº†ã¨è¨˜æ†¶ã—ãŸæƒ…å ±ã®ç¢ºèª
            let chatMessage = `AIï¼ˆã­ã“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ï¼‰: **ã€è¨˜æ†¶ã—ãŸã«ã‚ƒï¼ã€‘** ${name}ã®åœ¨åº«ã‚’**${stock}å€‹**ã¨ç¢ºèªã—ãŸã«ã‚ƒï¼`;
            logAction(`ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€å†™çœŸç™»éŒ²ã€‘${name}ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`, 'photo');
            logAction(chatMessage, 'chat');
            
            // å…±åŒä½œæ¥­ (2): äºˆæ¸¬ã¨æ¬¡ã®ææ¡ˆæ—¥ã®å†ç¢ºèª
            let followUpMessage = `AIï¼ˆã­ã“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ï¼‰: ã“ã®ãƒšãƒ¼ã‚¹ã ã¨ã€æ¬¡ã«ç¢ºèªã™ã‚‹ã®ã¯**ç´„${days}æ—¥å¾Œ**ã ã«ã‚ƒã‚“ã€‚ã‚‚ã—ã“ã®æ—¥æ•°ã‚’å¤‰ãˆãŸã„ãªã‚‰ã€ã„ã¤ã§ã‚‚æ•™ãˆã¦ã«ã‚ƒï¼`;
            setTimeout(() => { logAction(followUpMessage, 'chat'); }, 1000);

        } else if (actionType === 'FAMILY_ORDER') {
            const { name } = data;
            const chatMessage = `å®¶æ—: ${name}ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ³¨æ–‡ã—ã¾ã—ãŸã€‚ã€‡ã€‡ã•ã‚“ã€ã‚‚ã†ã™ãå±Šãã¾ã™ã‚ˆã€‚`;
            logAction(chatMessage, 'family_order');
        }
    }, [db, seniorId, inventory, familyName, mode, familyViewId]);

    // ----------------------------------------------------------------------
    // --- UI Components ---
    // ----------------------------------------------------------------------

    if (loading && !authReady) {
        return <LoadingScreen message="åˆæœŸè¨­å®šã¨èªè¨¼ä¸­..." />;
    }

    if (!firebaseConfig) {
        return <LoadingScreen message="Firebaseè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¢ãƒ—ãƒªIDã¨è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" isError={true} />;
    }

    const commonContainer = "max-w-4xl mx-auto p-4 sm:p-6 bg-gray-50 min-h-screen";

    const Header = ({ title, showModeSwitch = true }) => (
        <header className="flex justify-between items-center pb-4 border-b border-pink-300">
            <h1 className={LARGE_TEXT + " text-gray-800 flex items-center"}>
                {mode === 'USER' && 'ğŸ˜º'} {title}
            </h1>
            {showModeSwitch && (
                <div className="flex space-x-2">
                    <button
                        onClick={() => setMode('USER')}
                        className={`px-4 py-2 text-sm rounded-full font-bold transition shadow-md ${mode === 'USER' ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-pink-100'}`}
                    >
                        ã”æœ¬äººãƒ¢ãƒ¼ãƒ‰
                    </button>
                    <button
                        onClick={() => setMode('FAMILY')}
                        className={`px-4 py-2 text-sm rounded-full font-bold transition shadow-md ${mode === 'FAMILY' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-emerald-100'}`}
                    >
                        ã”å®¶æ—ãƒ¢ãƒ¼ãƒ‰
                    </button>
                </div>
            )}
        </header>
    );

    // --- 4. é«˜é½¢è€…ã”æœ¬äººãƒ¢ãƒ¼ãƒ‰ (USER) ---
    const UserView = () => {
        const [showModal, setShowModal] = useState(false);
        const [itemName, setItemName] = useState('');
        const [itemStock, setItemStock] = useState(1);
        const [itemDays, setItemDays] = useState(30);

        const InventoryModal = () => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                <div className="bg-white p-6 rounded-3xl w-full max-w-md shadow-2xl">
                    <h3 className="text-2xl font-black mb-4 text-gray-800 flex items-center">
                        <Camera className="mr-3 text-pink-500" size={28} />
                        åœ¨åº«ã‚’è¨˜éŒ²ã™ã‚‹
                    </h3>
                    <p className="text-gray-600 mb-4 font-semibold">
                        å•†å“ã®**å†™çœŸ**ã‚’æ’®ã‚‹ã‹ã€æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    
                    <div className="space-y-4">
                        <div className="flex items-center space-x-3 p-4 bg-yellow-100 rounded-xl border border-yellow-300 shadow-inner">
                            <Camera size={24} className="text-yellow-600 flex-shrink-0" />
                            <p className="text-base text-yellow-800">
                                AIãŒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã‚“ã§ã€å•†å“åãªã©ã‚’è‡ªå‹•ã§å…¥åŠ›ã—ãŸæƒ³å®šã§ã™ã€‚
                            </p>
                        </div>
                        
                        <InputGroup label="å•†å“å" value={itemName} onChange={setItemName} placeholder="ä¾‹: ãŠç±³ (å†™çœŸã‹ã‚‰èªè­˜)" />
                        <InputGroup label="ç¾åœ¨ã®åœ¨åº«æ•° (å€‹)" type="number" value={itemStock} onChange={v => setItemStock(Math.max(1, parseInt(v, 10)))} />
                        <InputGroup label="æ¬¡ã®ææ¡ˆã¾ã§ã®æ—¥æ•°" type="number" value={itemDays} onChange={v => setItemDays(Math.max(1, parseInt(v, 10)))} />
                    </div>

                    <div className="flex space-x-3 mt-6">
                        <button
                            onClick={() => setShowModal(false)}
                            className="flex-1 p-4 bg-gray-300 text-gray-700 rounded-2xl font-bold hover:bg-gray-400 transition"
                        >
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button
                            onClick={() => {
                                if (itemName && itemStock > 0 && itemDays > 0) {
                                    handleChatAction('ADD_ITEM', { name: itemName, stock: itemStock, days: itemDays });
                                    setItemName('');
                                    setItemStock(1);
                                    setItemDays(30);
                                    setShowModal(false);
                                }
                            }}
                            className="flex-1 p-4 bg-pink-500 text-white rounded-2xl font-black shadow-lg hover:bg-pink-600 transition"
                        >
                            <CheckCircle size={20} className="inline mr-2" />
                            è¨˜éŒ²ã—ã¦AIã«è¨˜æ†¶ã•ã›ã‚‹
                        </button>
                    </div>
                </div>
            </div>
        );

        return (
            <div className={commonContainer}>
                <Header title={`${familyName}æ§˜ã®AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥`} showModeSwitch={true} />
                
                <section className="mt-6 space-y-4">
                    <p className="text-xl text-gray-700 font-black flex items-center">
                        <MessageSquare className="mr-2 text-pink-600" size={24} />
                        ã­ã“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã¨ã®å¯¾è©±
                    </p>
                    <div className={CARD_CLASSES + " h-52 overflow-y-auto space-y-3 border-emerald-300"}>
                        {activityLog.slice(0, 10).map(log => (
                            <LogEntry key={log.id} log={log} isSenior={true} />
                        ))}
                    </div>
                    
                    <div className="flex space-x-4">
                        <button
                            onClick={() => handleChatAction('CHECK_INVENTORY')}
                            className={BUTTON_SECONDARY + " flex-1 p-4 font-black text-xl"}
                        >
                            <MessageSquare size={24} className="inline mr-2" />
                            AIã«ç›¸è«‡
                        </button>
                        <button
                            onClick={() => setShowModal(true)}
                            className={BUTTON_PRIMARY + " flex-1 p-4 font-black text-xl"}
                        >
                            <Camera size={24} className="inline mr-2" />
                            åœ¨åº«ã‚’è¨˜éŒ²ã™ã‚‹
                        </button>
                    </div>
                </section>

                <section className="mt-8 space-y-4">
                    <p className="text-xl text-gray-700 font-black flex items-center">
                        <List className="mr-2 text-pink-600" size={24} />
                        ç¾åœ¨ã®åœ¨åº«ãƒªã‚¹ãƒˆ
                    </p>
                    <InventoryTable data={inventory} seniorId={seniorId} db={db} appId={appId} />
                </section>

                {showModal && <InventoryModal />}
            </div>
        );
    };

    // --- 5. å®¶æ—ãƒ¢ãƒ¼ãƒ‰ (FAMILY) ---
    const FamilySetup = () => (
        <div className={CARD_CLASSES + " mt-8 border-emerald-300"}>
            <h3 className="text-2xl font-black mb-4 text-gray-800">
                <Users className="inline mr-2 text-emerald-600" size={24} />
                ã”å®¶æ—ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹
            </h3>
            <p className="text-gray-600 mb-4">
                é–²è¦§ã—ãŸã„**é«˜é½¢è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ID**ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã“ã®IDã¯ã€ã”æœ¬äººãƒ¢ãƒ¼ãƒ‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
                <br/>
                <span className="text-sm font-black text-pink-500">ï¼ˆãƒ‡ãƒ¢ç”¨ID: {seniorId || 'èªè¨¼å®Œäº†å¾Œã«è¡¨ç¤º'}ï¼‰</span>
            </p>
            <div className="flex space-x-3">
                <input
                    type="text"
                    placeholder="é«˜é½¢è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›"
                    value={familyViewId}
                    onChange={(e) => setFamilyViewId(e.target.value)}
                    className={INPUT_CLASSES + " flex-1"}
                />
                <button
                    onClick={() => {
                        if (familyViewId) {
                            // å®¶æ—ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ (ãƒ‡ãƒ¼ã‚¿ç›£è¦–ã¯useEffectãŒè‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆ)
                            setMode('FAMILY_VIEW');
                        } else {
                            console.error("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                            alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); 
                        }
                    }}
                    className="p-3 bg-emerald-500 text-white rounded-2xl font-bold shadow-md hover:bg-emerald-600 transition"
                >
                    ã‚¢ã‚¯ã‚»ã‚¹
                </button>
            </div>
        </div>
    );

    const FamilyView = () => {
        const [orderItem, setOrderItem] = useState('');
        const [showOrderModal, setShowOrderModal] = useState(false);

        const OrderModal = () => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                <div className="bg-white p-6 rounded-3xl w-full max-w-md shadow-2xl">
                    <h3 className="text-2xl font-black mb-4 text-gray-800 flex items-center">
                        ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ³¨æ–‡ä»£è¡Œ
                    </h3>
                    <p className="text-gray-600 mb-4">
                        **{familyName}æ§˜**ã«ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§æ³¨æ–‡ã™ã‚‹å•†å“ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
                    </p>
                    <InputGroup label="æ³¨æ–‡ã—ãŸå•†å“å" value={orderItem} onChange={setOrderItem} placeholder="ä¾‹: ãŠç±³ 5kg" />

                    <div className="flex space-x-3 mt-6">
                        <button
                            onClick={() => setShowOrderModal(false)}
                            className="flex-1 p-4 bg-gray-300 text-gray-700 rounded-2xl font-bold hover:bg-gray-400 transition"
                        >
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button
                            onClick={() => {
                                if (orderItem) {
                                    handleChatAction('FAMILY_ORDER', { name: orderItem });
                                    setOrderItem('');
                                    setShowOrderModal(false);
                                }
                            }}
                            className="flex-1 p-4 bg-emerald-500 text-white rounded-2xl font-black shadow-lg hover:bg-emerald-600 transition"
                        >
                            <CheckCircle size={20} className="inline mr-2" />
                            æ³¨æ–‡ã‚’è¨˜éŒ²
                        </button>
                    </div>
                </div>
            </div>
        );


        return (
            <div className={commonContainer}>
                <Header title={`ã€ã”å®¶æ—ã€‘${familyName}æ§˜ã®çŠ¶æ³`} showModeSwitch={true} />
                
                <section className={CARD_CLASSES + " mt-6 border-pink-300"}>
                    <h2 className="text-2xl font-black text-gray-800 flex items-center">
                        <Home className="mr-2 text-emerald-600" size={24} />
                        ç”Ÿæ´»ã¨åœ¨åº«ã®çŠ¶æ³
                    </h2>
                    <div className="flex justify-between items-center border-b pb-3 pt-4">
                        <p className="font-semibold text-lg text-gray-700">æœ€çµ‚ç¢ºèªæ—¥æ™‚</p>
                        <p className="text-lg font-black text-gray-900">{timeAgo(activityLog[0]?.timestamp)}</p>
                    </div>
                    <div className="flex justify-between items-center border-b pb-3">
                        <p className="font-semibold text-lg text-gray-700">å®‰å¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</p>
                        <p className={`text-lg font-black ${activityLog[0]?.type === 'chat' || activityLog[0]?.type === 'photo' ? 'text-pink-600' : 'text-yellow-600'}`}>
                            {activityLog[0]?.type === 'chat' || activityLog[0]?.type === 'photo' ? 'ğŸŸ¢ æ´»å‹•ã‚ã‚Š' : 'ğŸŸ¡ ç¢ºèªå¿…è¦'}
                        </p>
                    </div>

                    <button
                        onClick={() => setShowOrderModal(true)}
                        className={BUTTON_SECONDARY + " w-full mt-4 p-4 font-black text-xl"}
                    >
                        <List size={24} className="inline mr-2" />
                        ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ³¨æ–‡ã‚’ä»£è¡Œãƒ»è¨˜éŒ²
                    </button>
                </section>

                <section className="mt-8 space-y-4">
                    <p className="text-xl text-gray-700 font-black flex items-center">
                        <List className="mr-2 text-emerald-600" size={24} />
                        ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒªã‚¹ãƒˆ
                    </p>
                    <InventoryTable data={inventory} isFamily={true} />
                </section>

                <section className="mt-8 space-y-4">
                    <p className="text-xl text-gray-700 font-black flex items-center">
                        <MessageSquare className="mr-2 text-emerald-600" size={24} />
                        æ´»å‹•ãƒ­ã‚° (AIã¨ã®ä¼šè©±å«ã‚€)
                    </p>
                    <div className={CARD_CLASSES + " h-52 overflow-y-auto space-y-3 border-pink-300"}>
                        {activityLog.slice(0, 10).map(log => (
                            <LogEntry key={log.id} log={log} isSenior={false} />
                        ))}
                    </div>
                </section>
                {showOrderModal && <OrderModal />}
            </div>
        );
    };


    // 7. ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    if (mode === 'SETUP' || (mode === 'FAMILY' && !familyViewId)) {
        return (
            <div className={commonContainer}>
                <Header title="é«˜é½¢è€…å‘ã‘AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã‚¢ãƒ—ãƒª" showModeSwitch={true} />
                {mode === 'SETUP' && (
                    <div className={CARD_CLASSES + " mt-8 text-center border-pink-300"}>
                        <p className="text-2xl font-black text-pink-700">ã”åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        <p className="mt-2 text-gray-600">ç¾åœ¨ã€èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆID: {seniorId}ï¼‰</p>
                    </div>
                )}
                {mode === 'FAMILY' && <FamilySetup />}
            </div>
        );
    }

    if (mode === 'USER') {
        return <UserView />;
    }

    if (mode === 'FAMILY_VIEW') {
        return <FamilyView />;
    }
};

export default App;
